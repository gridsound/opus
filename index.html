<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
</head>
<body>

<input type="file"/>

<script>
const elInput = document.querySelector( "input" );
const worker = new Worker( "worker/EmsWorkerProxy.js" );

elInput.onchange = () => {
	const f = elInput.files[ 0 ];
	const reader = new FileReader();

	elInput.disabled = true;
	reader.addEventListener( "loadend", () => {
		worker.postMessage( {
			command: "encode",
			args: [ f.name, "encoded.opus" ],
			outData: { "encoded.opus": { "MIME": "audio/ogg" } },
			fileData: { [ f.name ]: new Uint8Array( reader.result ) },
		} );
	} );
	reader.readAsArrayBuffer( f );
};

worker.onmessage = e => {
	if ( e.data ) {
		const val = e.data.values;

		switch( e.data.reply ) {
			case "progress":
				if ( val[ 1 ] ) {
					console.log( `progress: ${ val[ 0 ] / val[ 1 ] * 100 }%` );
				}
				break;
			case "done":
				console.log( "progress: 100%" );
				for ( const fileName in val ) {
					console.log( fileName );
					console.log( val[ fileName ].blob );
					GSUdownloadBlob( fileName, val[ fileName ].blob );
				}
				break;
		}
	}
};

// .............................................................................
function GSUcreateElement( tag, attr, ...children ) {
	return _GSUcreateElement( "http://www.w3.org/1999/xhtml", tag, attr, children );
}
function _GSUcreateElement( ns, tag, attrObj, children ) {
	const el = document.createElementNS( ns, tag );

	GSUsetAttribute( el, attrObj );
	el.append( ...children.flat( 1 ).filter( ch => Boolean( ch ) || Number.isFinite( ch ) ) );
	return el;
}
function GSUcreateA( attr, ...child ) { return GSUcreateElement( "a", { href: true, ...attr }, ...child ); }

function GSUsetAttribute( el, attr, val ) {
	if ( typeof attr === "string" ) {
		_GSUsetAttribute( el, attr, val );
	} else if ( attr ) {
		Object.entries( attr ).forEach( kv => _GSUsetAttribute( el, ...kv ) );
	}
}
function _GSUsetAttribute( el, attr, val ) {
	if ( val === false || val === null || val === undefined ) {
		el.removeAttribute( attr );
	} else if ( attr === "style" && typeof val !== "string" ) {
		GSUforEach( val, ( val, prop ) => el.style[ prop ] = val );
	} else {
		el.setAttribute( attr, val === true ? "" : val );
	}
}

function GSUdownloadURL( name, url ) {
	const a = GSUcreateA( {
		href: url,
		download: name,
		target: "_blank"
	} );

	document.body.append( a );
	a.click();
	a.remove();
}
function GSUdownloadBlob( name, blob ) {
	GSUdownloadURL( name, URL.createObjectURL( blob ) );
}
</script>
</body>
</html>
